{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Checkout</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700,800" rel="stylesheet">

    <link rel="stylesheet" href="{% static 'user_side/css/open-iconic-bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'user_side/css/animate.css' %}">
    
    <link rel="stylesheet" href="{% static 'user_side/css/owl.carousel.min.css' %}">
    <link rel="stylesheet" href="{% static 'user_side/css/owl.theme.default.min.css' %}">
    <link rel="stylesheet" href="{% static 'user_side/css/magnific-popup.css' %}">

    <link rel="stylesheet" href="{% static 'user_side/css/aos.css' %}">

    <link rel="stylesheet" href="{% static 'user_side/css/ionicons.min.css' %}">

    <link rel="stylesheet" href="{% static 'user_side/css/bootstrap-datepicker.css' %}">
    <link rel="stylesheet" href="{% static 'user_side/css/jquery.timepicker.css' %}">

    
    <link rel="stylesheet" href="{% static 'user_side/css/flaticon.css' %}">
    <link rel="stylesheet" href="{% static 'user_side/css/icomoon.css' %}">
    <link rel="stylesheet" href="{% static 'user_side/css/style.css' %}">
  </head>
  <style>
    .cart-item {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e9ecef;
    }
    
    .cart-item-image {
        width: 80px;
        height: 80px;
        object-fit: cover;
        margin-right: 15px;
        border-radius: 8px;
    }
    
    .cart-item-details h5 {
        margin-bottom: 5px;
        font-size: 1rem;
    }
    
    .cart-item-details .text-muted {
        color: #6c757d;
        font-size: 0.9rem;
    }
    </style>
  <body class="goto-here">
    </div>
	<nav class="navbar navbar-expand-lg navbar-dark ftco_navbar bg-dark ftco-navbar-light fixed-top" id="ftco-navbar">
		<div class="container">
		  <a class="navbar-brand" href="{% url 'home' %}" style="color: white;">Noirette</a>
		  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#ftco-nav" aria-controls="ftco-nav" aria-expanded="false" aria-label="Toggle navigation">
			<span class="oi oi-menu"></span> Menu
		  </button>
	  
		  <div class="collapse navbar-collapse" id="ftco-nav">
			<ul class="navbar-nav ml-auto">
			  <li class="nav-item active"><a href="{% url 'home' %}" class="nav-link" style="color: white;">Home</a></li>
			  <li class="nav-item"><a href="{% url 'shop' %}" class="nav-link" style="color: white;">Shop</a></li>
			  <li class="nav-item"><a href="about.html" class="nav-link" style="color: white;">About</a></li>
			  <li class="nav-item"><a href="blog.html" class="nav-link" style="color: white;">Blog</a></li>
			  <li class="nav-item"><a href="contact.html" class="nav-link" style="color: white;">Contact</a></li>
			  <li class="nav-item cta cta-colored">
				<a href="{% url 'view_cart' %}" class="nav-link" style="color: white;">
					<span class="icon-shopping_cart"></span>[{{ cart_count|default:0 }}]
				</a>
			  </li>
			  <li class="nav-item cta cta-colored">
				<a href="{% url 'wishlist' %}" class="nav-link" style="color: white;">
					<span class="icon-heart"></span>[0]
				</a>
			</li>
			          <!-- Wallet Section -->
					  {% if user.is_authenticated %}
					  <li class="nav-item cta">
						<a href="{% url 'wallet' %}" class="nav-link" style="color: white;">
						  <span class="icon-wallet"></span> Wallet: ₹{{ user.wallet_balance|default:0.00 }}
						</a>
					  </li>
					  {% endif %}
			  <!-- Display Login or Username/Logout -->
			  {% if user.is_authenticated %}
			<li class="nav-item dropdown">
			<a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="color: white;">
				Welcome, {{ user.username }}
			</a>
			<div class="dropdown-menu" aria-labelledby="userDropdown">
				<!-- User Profile Button -->
				<a href="{% url 'user_profile' %}" class="dropdown-item" 
				   style="display: flex; justify-content: center; align-items: center; text-decoration: none; 
						  color: white; padding: 5px 10px; font-size: 14px;">
					<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" 
						 class="bi bi-person-circle me-2" viewBox="0 0 16 16">
						<path d="M13 8a5 5 0 1 1-10 0 5 5 0 0 1 10 0z"/>
						<path d="M11 8c0 1.105-.45 2.09-1.175 2.828A3.972 3.972 0 0 1 8 12c-.79 0-1.524-.268-2.175-.735C5.45 10.09 5 9.105 5 8c0-1.105.45-2.09 1.175-2.828A3.972 3.972 0 0 1 8 4c.79 0 1.524.268 2.175.735C10.55 5.91 11 6.895 11 8zm-3-1a1 1 0 1 0 0 2 1 1 0 0 0 0-2z"/>
					</svg>
					My Profile
				</a>
			
				<!-- Logout Button -->
				<form method="post" action="{% url 'logout' %}" style="display: inline;">
					{% csrf_token %}
					<button type="submit" class="dropdown-item" 
							style="display: flex; justify-content: center; align-items: center; background: none; 
								   border: none; padding: 5px 10px; font-size: 14px; cursor: pointer; color: white;">
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" 
							 class="bi bi-box-arrow-right me-2" viewBox="0 0 16 16">
							<path fill-rule="evenodd" d="M10 15a1 1 0 0 1-1 1H5a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h4a1 1 0 0 1 1 1v1H5.5A1.5 1.5 0 0 0 4 3.5v9A1.5 1.5 0 0 0 5.5 14H10v1zm1-11a.5.5 0 0 0 0 1h4.5a.5.5 0 0 0 0-1H11zm3.646 3.646a.5.5 0 0 1 0 .708l-2.5 2.5a.5.5 0 0 1-.708-.708L13.293 8H8.5a.5.5 0 0 1 0-1h4.793l-1.647-1.646a.5.5 0 1 1 .708-.708l2.5 2.5z"/>
						</svg>
						Logout
					</button>
				</form>
			</div>
			
			</li>
			{% else %}
			<li class="nav-item"><a href="{% url 'login' %}" class="nav-link" style="color: white;">Login</a></li>
			{% endif %}
			</ul>
		  </div>
		</div>
	  </nav>
    <!-- END nav -->

    <div class="hero-wrap hero-bread" style="position: relative; margin-top: 0; padding: 0;">
		<img src="{% static 'user_side/images/image2.jpg' %}" alt="Hero Image" style="width: 100%; height: 65vh; object-fit: cover;">
		<div class="hero-text text-center" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.7); z-index: 5;">
			<p class="breadcrumbs">
				<a href="{% url 'home' %}" style="color: #fff; text-decoration: none;">Home</a> 
				<span style="color: #fff;">Checkout</span>
			</p>
			<h1 class="mb-0 bread" style="font-size: 3rem; color: #fff; font-weight: bold;">Checkout</h1>
		</div>
	</div>

    <!-- Checkout Section -->
    <section class="ftco-section">
        <div class="container">
            <div class="row justify-content-center">
                <!-- Left Section: Billing Details -->
                <div class="col-md-6 ftco-animate">
                    <form method="POST" action="{% url 'order:place_order' %}" class="billing-form">
                        {% csrf_token %}
                    
                        <!-- Billing Details -->
                        <h3 class="mb-4 billing-heading">Billing Details</h3>
                    
                        <!-- Saved Address Section -->
                        <div class="form-group">
                            <label for="address">Choose Shipping Address</label>
                            <select name="saved_address" id="address" class="form-control" required>
                                <option value="">-- Select an Address --</option>
                                {% for address in addresses %}
                                    <option value="{{ address.id }}">
                                        {{ address.first_name }} {{ address.last_name }} - 
                                        {{ address.street_address }}, {{ address.city }}, {{ address.postcode }}
                                    </option>
                                {% endfor %}
                            </select>
                            <a href="{% url 'add_address' %}" class="btn btn-link mt-2">Add New Address</a>
                        </div>
                    
                        <!-- Payment Method Section -->
                        <h3 class="billing-heading mb-4 mt-4">Payment Method</h3>
                        <div class="form-group">
                            <div class="form-check">
                                <input 
                                    class="form-check-input" 
                                    type="radio" 
                                    id="cod" 
                                    name="payment_method" 
                                    value="cod" 
                                    {% if total > 1000 %}disabled{% endif %} 
                                    required>
                                <label class="form-check-label" for="cod">
                                    Cash on Delivery (COD)
                                    {% if total > 1000 %}<small class="text-danger">(Not available for orders above ₹1000)</small>{% endif %}
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" id="razorpay" name="payment_method" value="razorpay" required>
                                <label class="form-check-label" for="razorpay">Razorpay</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" id="wallet" name="payment_method" value="wallet" required>
                                <label class="form-check-label" for="wallet">
                                    Wallet (Current Balance: ₹{{ wallet.balance|floatformat:2 }})
                                </label>
                            </div>
                        </div>
                    
                        <!-- Submit Button -->
                        <div class="mt-4 text-center">
                            <button type="submit" class="btn btn-primary py-3 px-4">Place Order</button>
                        </div>
                    </form>                                     
                </div>
    
                <!-- Right Section: Cart Summary -->
                <div class="col-md-5 offset-md-1 ftco-animate">
                    <div class="cart-summary bg-light p-4">
                        <h3 class="billing-heading mb-4">Cart Summary</h3>
    
                        {% for item in cart_items %}
    <div class="cart-item d-flex align-items-center mb-3">
        {% if item.variant.product.image %}
            <img src="{{ item.variant.product.image.url }}" 
                 alt="{{ item.variant.product.name }}" 
                 class="mr-3" 
                 style="width: 50px; height: 50px; object-fit: cover;">
        {% endif %}
        <div>
            <h6>{{ item.variant.product.name }}</h6>
            <p>
                Price: ₹{{ item.discounted_price|floatformat:2 }} x {{ item.quantity }}
            </p>
        </div>
    </div>
{% endfor %}
                        <hr>
    
                        <!-- Coupon Section -->
                        <div class="cart-summary">
                            <div class="coupon-input-group mb-3">
                                <div class="input-group">
                                    <input type="text" 
                                           id="coupon-input" 
                                           class="form-control" 
                                           placeholder="Enter coupon code"
                                           {% if cart.applied_coupon %}disabled{% endif %}>
                                    <div class="input-group-append">
                                        <button 
                                            id="coupon-btn" 
                                            class="btn {% if cart.applied_coupon %}btn-danger{% else %}btn-primary{% endif %}" 
                                            onclick="handleCoupon()">
                                            {% if cart.applied_coupon %}
                                                Remove Coupon
                                            {% else %}
                                                Apply Coupon
                                            {% endif %}
                                        </button>
                                    </div>
                                </div>
                                <p id="coupon-message" class="mt-2"></p>
                            </div>
    
                            <!-- Available Coupons Section -->
                            <div class="available-coupons mt-3">
                                <h6>Available Coupons</h6>
                                <ul class="list-unstyled">
                                    {% for coupon in available_coupons %}
                                        <li class="mb-2">
                                            <strong>{{ coupon.code }}</strong>: 
                                            {% if coupon.discount_type == 'percentage' %}
                                                {{ coupon.discount_value }}% Off
                                            {% else %}
                                                ₹{{ coupon.discount_value }} Off
                                            {% endif %}
                                            <br>
                                            <small class="text-muted">
                                                Min Purchase: ₹{{ coupon.min_purchase_amount|floatformat:2 }}
                                            </small>
                                        </li>
                                    {% empty %}
                                        <p>No applicable coupons at the moment.</p>
                                    {% endfor %}
                                </ul>
                            </div>

                        </div>
                        
                        <hr>
    
                        <!-- Price Breakdown -->
                        <div class="price-breakdown">
                            <p class="d-flex justify-content-between total-price">
                                <span>Subtotal:</span>
                                <span id="subtotal-price">₹{{ subtotal|floatformat:2 }}</span>
                            </p>
                            
                            <p class="d-flex justify-content-between total-price">
                                <span>Delivery:</span>
                                <span id="delivery-price">₹{{ delivery|floatformat:2 }}</span>
                            </p>
                            
                            {% if cart.applied_coupon %}
                                <p id="coupon-discount-row" class="d-flex justify-content-between total-price text-success">
                                    <span>Coupon Discount ({{ cart.applied_coupon.code }}):</span>
                                    <span id="coupon-discount">-₹{{ discount|floatformat:2 }}</span>
                                </p>
                            {% endif %}
                            
                            <p class="d-flex justify-content-between total-price font-weight-bold">
                                <span>Total:</span>
                                <span id="total-price">₹{{ total|floatformat:2 }}</span>
                            </p>
                        </div>
                    </div>
                </div>
                
                    </div>
                </div>
            </div>
        </div>
    </section>


    
    <footer class="ftco-footer ftco-section">
        <div class="container">
          <div class="row">
            <div class="mouse">
                  <a href="#" class="mouse-icon">
                    <div class="mouse-wheel"><span class="ion-ios-arrow-up"></span></div>
                  </a>
                </div>
          </div>
          <div class="row mb-5">
          <div class="col-md">
            <div class="ftco-footer-widget mb-4">
            <h2 class="ftco-heading-2">Noirette</h2>
            <p>Indulge in the art of fine chocolate. At Noirette, we craft every piece with love and passion to deliver the ultimate chocolate experience.</p>
            <ul class="ftco-footer-social list-unstyled float-md-left float-lft mt-5">
              <li class="ftco-animate"><a href="#"><span class="icon-twitter"></span></a></li>
              <li class="ftco-animate"><a href="#"><span class="icon-facebook"></span></a></li>
              <li class="ftco-animate"><a href="#"><span class="icon-instagram"></span></a></li>
            </ul>
            </div>
          </div>
          <div class="col-md">
            <div class="ftco-footer-widget mb-4 ml-md-5">
            <h2 class="ftco-heading-2">Menu</h2>
            <ul class="list-unstyled">
              <li><a href="{% url 'shop' %}" class="py-2 d-block">Shop Chocolates</a></li>
              <li><a href="#" class="py-2 d-block">About Noirette</a></li>
              <li><a href="#" class="py-2 d-block">Our Journal</a></li>
              <li><a href="#" class="py-2 d-block">Contact Us</a></li>
            </ul>
            </div>
          </div>
          <div class="col-md-4">
             <div class="ftco-footer-widget mb-4">
            <h2 class="ftco-heading-2">Help</h2>
            <div class="d-flex">
              <ul class="list-unstyled mr-l-5 pr-l-3 mr-4">
                <li><a href="#" class="py-2 d-block">Shipping Information</a></li>
                <li><a href="#" class="py-2 d-block">Returns &amp; Exchanges</a></li>
                <li><a href="#" class="py-2 d-block">Terms &amp; Conditions</a></li>
                <li><a href="#" class="py-2 d-block">Privacy Policy</a></li>
              </ul>
              <ul class="list-unstyled">
                <li><a href="#" class="py-2 d-block">FAQs</a></li>
                <li><a href="#" class="py-2 d-block">Contact Support</a></li>
              </ul>
              </div>
            </div>
          </div>
          <div class="col-md">
            <div class="ftco-footer-widget mb-4">
              <h2 class="ftco-heading-2">Have Questions?</h2>
              <div class="block-23 mb-3">
              <ul>
                <li><span class="icon icon-map-marker"></span><span class="text">Noirette , Kochi, Ernakulam, Kerala, India</span></li>
                <li><a href="#"><span class="icon icon-phone"></span><span class="text">+91 9633558031</span></a></li>
                <li><a href="#"><span class="icon icon-envelope"></span><span class="text">support@noirette.com</span></a></li>
              </ul>
              </div>
            </div>
          </div>
          </div>
          <div class="row">
          
          </div>
        </div>
        </footer>
      
    
  

  <!-- loader -->
  <div id="ftco-loader" class="show fullscreen"><svg class="circular" width="48px" height="48px"><circle class="path-bg" cx="24" cy="24" r="22" fill="none" stroke-width="4" stroke="#eeeeee"/><circle class="path" cx="24" cy="24" r="22" fill="none" stroke-width="4" stroke-miterlimit="10" stroke="#F96D00"/></svg></div>


  <script src="{% static 'user_side/js/jquery.min.js' %}"></script>
  <script src="{% static 'user_side/js/jquery-migrate-3.0.1.min.js' %}"></script>
  <script src="{% static 'user_side/js/popper.min.js' %}"></script>
  <script src="{% static 'user_side/js/bootstrap.min.js' %}"></script>
  <script src="{% static 'user_side/js/jquery.easing.1.3.js' %}"></script>
  <script src="{% static 'user_side/js/jquery.waypoints.min.js' %}"></script>
  <script src="{% static 'user_side/js/jquery.stellar.min.js' %}"></script>
  <script src="{% static 'user_side/js/owl.carousel.min.js' %}"></script>
  <script src="{% static 'user_side/js/jquery.magnific-popup.min.js' %}"></script>
  <script src="{% static 'user_side/js/aos.js' %}"></script>
  <script src="{% static 'user_side/js/jquery.animateNumber.min.js' %}"></script>
  <script src="{% static 'user_side/js/bootstrap-datepicker.js' %}"></script>
  <script src="{% static 'user_side/js/scrollax.min.js' %}"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBVWaKrjvy3MaE7SQ74_uJiULgl1JY0H2s&sensor=false"></script>
  <script src="{% static 'user_side/js/google-map.js' %}"></script>
  <script src="{% static 'user_side/js/main.js' %}"></script>
  <script src="{% static 'js/cart.js' %}"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> 
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <!-- Include SweetAlert2 CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

    
<script>
    document.getElementById('address').addEventListener('change', function () {
        const newAddressForm = document.getElementById('new-address-form');
        if (this.value === 'new') {
            newAddressForm.style.display = 'block';
        } else {
            newAddressForm.style.display = 'none';
        }
    });

    document.addEventListener("DOMContentLoaded", function () {
        const codInput = document.getElementById("cod");

        if (codInput.disabled) {
            codInput.addEventListener("click", function (event) {
                event.preventDefault();
                Swal.fire({
                    icon: 'warning',
                    title: 'COD Not Available',
                    text: 'Cash on Delivery is not available for orders above Rs 1000.',
                    confirmButtonText: 'OK'
                });
            });
        }
    });

    function handleCoupon() {
    const couponInput = document.getElementById('coupon-input');
    const couponBtn = document.getElementById('coupon-btn');
    const couponMessage = document.getElementById('coupon-message');
    
    const couponCode = couponInput.value.trim();
    
    // If coupon is already applied, handle removal
    if (couponBtn.textContent.trim() === 'Remove Coupon') {
        fetch("{% url 'remove_coupon' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `coupon_code=₹{couponCode}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                couponInput.disabled = false;
                couponInput.value = '';
                couponBtn.textContent = 'Apply Coupon';
                couponBtn.classList.remove('btn-danger');
                couponBtn.classList.add('btn-primary');

                couponMessage.textContent = data.message;
                
                // Reload the page to refresh the entire cart view
                location.reload();
            } else {
                couponMessage.textContent = data.message;
            }
        });
    } else {
        // Apply coupon
        if (!couponCode) {
            couponMessage.textContent = 'Please enter a coupon code';
            return;
        }

        fetch("{% url 'apply_coupon' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `coupon_code=₹{couponCode}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                couponInput.disabled = true;
                couponBtn.textContent = 'Remove Coupon';
                couponBtn.classList.remove('btn-primary');
                couponBtn.classList.add('btn-danger');

                couponMessage.textContent = data.message;
                
                // Reload the page to refresh the entire cart view
                location.reload();
            } else {
                couponMessage.textContent = data.message;
            }
        })
        .catch(error => {
            console.error('Error applying coupon:', error);
            couponMessage.textContent = 'An error occurred while applying the coupon.';
        });
    }
}

document.addEventListener('DOMContentLoaded', () => {
    function updateCartSummary(data) {
        // Update subtotal
        document.getElementById('subtotal-price').textContent = '₹' + data.subtotal.toFixed(2);
        
        // Update delivery
        document.getElementById('delivery-price').textContent = '₹' + data.delivery.toFixed(2);
        
        // Handle coupon discount section
        const couponDiscountContainer = document.querySelector('.price-breakdown');
        const existingCouponDiscount = document.getElementById('coupon-discount-row');
        
        if (data.discount > 0) {
            // If coupon discount row doesn't exist, create it
            if (!existingCouponDiscount) {
                const couponDiscountRow = document.createElement('p');
                couponDiscountRow.id = 'coupon-discount-row';
                couponDiscountRow.className = 'd-flex justify-content-between total-price text-success';
                couponDiscountRow.innerHTML = `
                    <span>Coupon Discount (₹{data.coupon_code}):</span>
                    <span id="coupon-discount">-₹₹{data.discount.toFixed(2)}</span>
                `;
                
                // Insert before the total row
                const totalRow = document.getElementById('total-price').closest('p');
                couponDiscountContainer.insertBefore(couponDiscountRow, totalRow);
            } else {
                // Update existing coupon discount row
                document.getElementById('coupon-discount').textContent = `-₹₹{data.discount.toFixed(2)}`;
            }
        } else {
            // Remove coupon discount row if it exists
            if (existingCouponDiscount) {
                existingCouponDiscount.remove();
            }
        }
        
        // Update total price
        document.getElementById('total-price').textContent = '₹' + data.total.toFixed(2);
    }

    function handleCoupon() {
        const couponInput = document.getElementById('coupon-input');
        const couponBtn = document.getElementById('coupon-btn');
        const couponMessage = document.getElementById('coupon-message');
        
        const couponCode = couponInput.value.trim();
        
        // Determine if we're applying or removing a coupon
        const isRemoving = couponBtn.textContent.trim() === 'Remove Coupon';
        
        // Prepare the URL and body based on action
        const url = isRemoving ? "{% url 'remove_coupon' %}" : "{% url 'apply_coupon' %}";
        const body = `coupon_code=₹{couponCode}`;
        
        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: body
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Update UI based on coupon action
                if (isRemoving) {
                    // Removing coupon
                    couponInput.disabled = false;
                    couponInput.value = '';
                    couponBtn.textContent = 'Apply Coupon';
                    couponBtn.classList.remove('btn-danger');
                    couponBtn.classList.add('btn-primary');
                } else {
                    // Applying coupon
                    couponInput.disabled = true;
                    couponBtn.textContent = 'Remove Coupon';
                    couponBtn.classList.remove('btn-primary');
                    couponBtn.classList.add('btn-danger');
                }
                
                // Update cart summary
                updateCartSummary(data);
                
                // Show success message
                couponMessage.textContent = data.message;
                couponMessage.classList.remove('text-danger');
                couponMessage.classList.add('text-success');
            } else {
                // Show error message
                couponMessage.textContent = data.message;
                couponMessage.classList.remove('text-success');
                couponMessage.classList.add('text-danger');
            }
        })
        .catch(error => {
            console.error('Error handling coupon:', error);
            couponMessage.textContent = 'An error occurred while processing the coupon.';
            couponMessage.classList.remove('text-success');
            couponMessage.classList.add('text-danger');
        });
    }

    // Attach the function to the global scope
    window.handleCoupon = handleCoupon;
});
</script>
<script>
    document.querySelector('form').addEventListener('submit', function(e) {
        const paymentMethod = document.querySelector('input[name="payment_method"]:checked').value;
        
        if (paymentMethod === 'razorpay') {
            e.preventDefault();
            
            // Send form data to server
            fetch("{% url 'order:place_order' %}", {
                method: 'POST',
                body: new FormData(this),
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const options = {
                        key: data.razorpay_key_id,
                        amount: data.amount,
                        currency: "INR",
                        name: "Your Store Name",
                        description: "Order Payment",
                        order_id: data.razorpay_order_id,
                        handler: function (response) {
                            // Handle payment success
                            fetch("{% url 'order:verify_payment' %}", {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-Requested-With': 'XMLHttpRequest',
                                    'X-CSRFToken': '{{ csrf_token }}'
                                },
                                body: JSON.stringify({
                                    razorpay_payment_id: response.razorpay_payment_id,
                                    razorpay_order_id: response.razorpay_order_id,
                                    razorpay_signature: response.razorpay_signature
                                })
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    window.location.href = "{% url 'order:order_success' %}";
                                } else {
                                    alert('Payment verification failed');
                                }
                            });
                        },
                        prefill: {
                            name: "{{ request.user.get_full_name }}",
                            email: "{{ request.user.email }}",
                        },
                        theme: {
                            color: "#3399cc"
                        }
                    };
                    const rzp1 = new Razorpay(options);
                    rzp1.open();
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
        }
    });
    </script>
  </body>
</html>